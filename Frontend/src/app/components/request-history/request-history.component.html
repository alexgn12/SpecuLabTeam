<div class="container">
  <div class="request-history-container">
    <header class="history-header my-4">
      <h2 class="page-title">Historial de Solicitudes</h2>
      <p class="page-subtitle">
        Consulta los cambios de estado de tus solicitudes
      </p>
    </header>

    <div class="card mb-4 border-0 rounded-4 shadow-sm">
      <div class="card-body">
        <form class="row g-3 align-items-end">
          <div class="col-md-3">
            <label for="requestId" class="form-label">ID de Solicitud</label>
            <input
              id="requestId"
              type="number"
              [(ngModel)]="requestId"
              class="form-control"
              name="requestId"
            />
          </div>
          <div class="col-md-3">
            <label for="fromDate" class="form-label">Desde</label>
            <input
              id="fromDate"
              type="date"
              [(ngModel)]="fromDate"
              class="form-control"
              name="fromDate"
            />
          </div>
          <div class="col-md-3">
            <label for="toDate" class="form-label">Hasta</label>
            <input
              id="toDate"
              type="date"
              [(ngModel)]="toDate"
              class="form-control"
              name="toDate"
            />
          </div>
          <div class="col-md-3 d-flex gap-2">
            <button
              type="button"
              class="btn btn-primary w-100"
              (click)="applyFilters()"
            >
              Aplicar Filtros
            </button>
            <button
              type="button"
              class="btn btn-outline-secondary w-100"
              (click)="resetFilters()"
            >
              Resetear
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      *ngIf="errorMsg"
      class="error-message"
      style="color: red; margin-bottom: 1rem"
    >
      {{ errorMsg }}
    </div>

<div class="sl-table-card mt-4">
  <div class="sl-table-wrap">
    <table *ngIf="history.length > 0" class="sl-table">
      <thead>
        <tr>
          <th class="col-id">ID de Solicitud</th>
          <th>Descripción</th>
          <th>Estado Anterior</th>
          <th>Estado Nuevo</th>
          <th class="col-date">Fecha de Cambio</th>
          <th>Comentario</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let item of history">
          <td class="fw-600"
              [attr.data-label]="'ID de Solicitud'">{{ item.requestId }}</td>

          <td [attr.data-label]="'Descripción'">{{ item.requestDescription }}</td>

          <td [attr.data-label]="'Estado Anterior'">
            <ng-container *ngIf="item.oldStatusType && item.oldStatusType.trim() as st">
              <span
                class="chip"
                [ngClass]="{
                  'chip--success': st === 'Aprobado' || st === 'Completado',
                  'chip--warning': st === 'Pendiente',
                  'chip--danger' : st === 'Rechazado' || st === 'Cancelado',
                  'chip--info'   : st === 'En proceso' || st === 'Revisando',
                  'chip--muted'  : true
                }"
              >{{ st }}</span>
            </ng-container>
          </td>

          <td [attr.data-label]="'Estado Nuevo'">
            <ng-container *ngIf="item.newStatusType && item.newStatusType.trim() as st">
              <span
                class="chip"
                [ngClass]="{
                  'chip--success': st === 'Aprobado' || st === 'Completado',
                  'chip--warning': st === 'Pendiente',
                  'chip--danger' : st === 'Rechazado' || st === 'Cancelado',
                  'chip--info'   : st === 'En proceso' || st === 'Revisando',
                  'chip--muted'  : true
                }"
              >{{ st }}</span>
            </ng-container>
          </td>

          <td class="nowrap"
              [attr.data-label]="'Fecha de Cambio'">{{ formatDate(item.changeDate) }}</td>

          <td class="ellipsis"
              [attr.data-label]="'Comentario'"
              [title]="item.comment">{{ item.comment }}</td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="history.length === 0" class="sl-table-empty">
      No hay historial para los filtros seleccionados.
    </div>
  </div>
</div>



    <app-paginacion
      [currentPage]="page"
  [totalPages]="totalPages"
      (pageChange)="page = $event; fetchHistory()"
      class="mt-3 mb-2 d-flex justify-content-center"
    ></app-paginacion>
  </div>
</div>
